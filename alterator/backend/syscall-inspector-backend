#!/bin/bash

export PATH=/usr/bin:/usr/sbin:/bin:/sbin
alterator_api_version=1
. alterator-sh-functions

DB_PATH="/var/lib/syscall-inspector/data.db"
CONFIG_PATH="/etc/syscall-inspector/config.conf"

list_data() {
    if [ ! -f "$DB_PATH" ]; then return; fi
    sqlite3 -separator "|" "$DB_PATH" \
    "SELECT timestamp, severity, event_type, process, details FROM alerts ORDER BY id DESC LIMIT 100;" 2>/dev/null |
    while IFS="|" read -r ts sev type proc det; do
        write_table_item time "$ts" severity "$sev" type "$type" process "$proc" details "$det"
    done
}

read_wazuh_status() {
    if [ -f "$CONFIG_PATH" ] && grep -q "wazuh_enabled = true" "$CONFIG_PATH"; then
        echo "#t"
    else
        echo "#f"
    fi
}

set_wazuh_status() {
    local enabled=$1
    mkdir -p "$(dirname "$CONFIG_PATH")"
    
    if [ ! -f "$CONFIG_PATH" ]; then
        echo "[General]" > "$CONFIG_PATH"
    fi
    
    if grep -q "wazuh_enabled" "$CONFIG_PATH"; then
        if [ "$enabled" = "#t" ]; then
            sed -i 's/wazuh_enabled.*/wazuh_enabled = true/' "$CONFIG_PATH"
        else
            sed -i 's/wazuh_enabled.*/wazuh_enabled = false/' "$CONFIG_PATH"
        fi
    else
        if [ "$enabled" = "#t" ]; then
            echo "wazuh_enabled = true" >> "$CONFIG_PATH"
        else
            echo "wazuh_enabled = false" >> "$CONFIG_PATH"
        fi
    fi

    systemctl try-restart syscall-inspector.service
}

on_message() {
    case "$in_action" in
        "list")          list_data ;;
        "read_wazuh")    echo "wazuh_state:$(read_wazuh_status)" ;;
        "set_wazuh")     set_wazuh_status "$in_wazuh_state" ;;
        *)               list_data ;;
    esac
}

message_loop
